From 111111111 Mon Sep 17 00:00:00 2001
From: Security Fixer <sec@example.com>
Subject: [PATCH 1/3] security: replace md5 with argon2 (CWE-916)

--- a/app.py
+++ b/app.py
@@
-import sqlite3, hashlib, os, re
+import sqlite3, hashlib, os, re
+from argon2 import PasswordHasher
@@
-# VULNERABLE: MD5 hashing without salt
-def md5_hash(password: str) -> str:
-    return hashlib.md5(password.encode("utf-8")).hexdigest()
+# Secure password hasher (Argon2id). Keep md5_hash for legacy detection.
+ph = PasswordHasher()
+def md5_hash(password: str) -> str:
+    # kept for legacy verification only
+    return hashlib.md5(password.encode("utf-8")).hexdigest()
+
+def argon2_hash(password: str) -> str:
+    return ph.hash(password)
@@
-    db.execute("INSERT INTO users(username, password_hash, algo) VALUES (?, ?, ?)", (username, md5_hash(password), "md5"))
+    db.execute("INSERT INTO users(username, password_hash, algo) VALUES (?, ?, ?)", (username, argon2_hash(password), "argon2"))
     db.commit()
     return redirect(url_for("index"))
@@
-    if row["password_hash"] == md5_hash(password):
-        return "OK", 200
+    if row["algo"] == "argon2":
+        try:
+            ph.verify(row["password_hash"], password)
+            return "OK", 200
+        except Exception:
+            return "Invalid credentials", 401
+    # Legacy md5 â€” allow once, then rehash (lazy migration)
+    if row["password_hash"] == md5_hash(password):
+        new_hash = argon2_hash(password)
+        db.execute("UPDATE users SET password_hash=?, algo=? WHERE id=?", (new_hash, "argon2", row["id"]))
+        db.commit()
+        return "OK", 200
     return "Invalid credentials", 401
--- a/tests/test_security.py
+++ b/tests/test_security.py
@@
-def test_md5_is_insecure():
-    # Policy: project must NOT use MD5
-    h = md5_hash("password123")
-    # length 32 hex proves it's md5 now; this test should fail AFTER fix when md5_hash removed/changed
-    assert len(h) == 32 and re.fullmatch(r"[0-9a-f]{32}", h)
+def test_md5_not_primary_algo():
+    # The project should not store new passwords as md5
+    from app import argon2_hash
+    h = argon2_hash("password123")
+    assert h.startswith("$argon2")
